<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:GraafikPiip.Converters"
    x:Class="GraafikPiip.Views.MonthCalendarPage"
    Title="Календарь">

    <!-- Локальные стили и цвета -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="Bg">#101010</Color>
            <Color x:Key="Card">#16191F</Color>
            <Color x:Key="Stroke">#242A33</Color>
            <Color x:Key="TextPri">#F3F4F6</Color>
            <Color x:Key="TextSec">#9AA0A6</Color>
            <Color x:Key="Danger">#E66A6A</Color>
            <Color x:Key="BtnBg">#000000</Color>

            <Style x:Key="H1" TargetType="Label">
                <Setter Property="FontSize" Value="22"/>
                <Setter Property="FontFamily" Value="ElMessiri-Regular.ttf"/>
                <Setter Property="TextColor" Value="{StaticResource TextPri}"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
                <Setter Property="VerticalTextAlignment" Value="Center"/>
            </Style>
            <Style x:Key="H2" TargetType="Label">
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="FontFamily" Value="ElMessiri-Regular.ttf"/>
                <Setter Property="TextColor" Value="{StaticResource TextPri}"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
            </Style>
            <Style x:Key="Body12" TargetType="Label">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="FontFamily" Value="ElMessiri-Regular.ttf"/>
                <Setter Property="TextColor" Value="{StaticResource TextPri}"/>
            </Style>
            <Style x:Key="TonalButton" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{StaticResource BtnBg}"/>
                <Setter Property="TextColor" Value="{StaticResource TextPri}"/>
                <Setter Property="CornerRadius" Value="10"/>
                <Setter Property="HeightRequest" Value="44"/>
                <Setter Property="Padding" Value="12,0"/>
                <Setter Property="Shadow">
                    <Setter.Value
                        InputTransparent="True"  
                        ZIndex="-1">>
                        <Shadow 
                            Brush="#f04e9e"
                            Radius="10"/> 
                    </Setter.Value>
                </Setter>
            </Style>
            <Style x:Key="DayCard" TargetType="Border">
                <Setter Property="Background" Value="{StaticResource Card}"/>
                <Setter Property="Stroke" Value="{StaticResource Stroke}"/>
                <Setter Property="StrokeThickness" Value="1"/>
                <Setter Property="Padding" Value="8"/>
                <Setter Property="Margin" Value="3"/>
                <Setter Property="StrokeShape" Value="RoundRectangle 10"/>
            </Style>
            <conv:ReferenceEqualConverter x:Key="RefEq"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid 
        BackgroundColor="{StaticResource Bg}"
        Padding="16"
        RowDefinitions="Auto,Auto,Auto,*"
        RowSpacing="12">

        <Grid  
            Grid.Row="0" 
            ColumnDefinitions="*,*,*" 
            ColumnSpacing="20">
            
            <Button 
                Grid.Column="0"
                Text="Lisa"    
                HorizontalOptions="Fill"
                Style="{StaticResource TonalButton}" 
                Command="{Binding LisaCommand}"
                Margin="0,0,0,50"/>
            
            <Button 
                Grid.Column="1"
                Text="Uuenda" 
                HorizontalOptions="Fill"
                Style="{StaticResource TonalButton}" 
                Command="{Binding UuendaCommand}"
                Margin="0,0,0,50"/>
            
            <Button 
                Grid.Column="2"
                Text="Kustuta" 
                HorizontalOptions="Fill"
                Style="{StaticResource TonalButton}" 
                Command="{Binding KustutaCommand}"
                Margin="0,0,0,50"/>
            
        </Grid>

        <!-- Шапка -->
        <Grid 
            Grid.Row="1" 
            ColumnDefinitions="Auto,*,Auto" 
            ColumnSpacing="12">
            
            <Button 
                Grid.Column="0" 
                Text="‹" 
                Style="{StaticResource TonalButton}"
                Command="{Binding EelmineKuuCommand}" 
                WidthRequest="44"/>
            
            <Label 
                Grid.Column="1" 
                Text="{Binding PealkiriKuu}" 
                Style="{StaticResource H1}"/>
            
            <Button 
                Grid.Column="2" 
                Text="›" 
                Style="{StaticResource TonalButton}"
                Command="{Binding JargmineKuuCommand}" 
                WidthRequest="44"/>
            
        </Grid>

        <!-- Дни недели -->
        <Grid 
            Grid.Row="2" 
            ColumnDefinitions="*,*,*,*,*,*,*" 
            ColumnSpacing="6">
            
            <Label 
                Grid.Column="0" 
                Text="{Binding PaevaPelkiri[0]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="1" 
                Text="{Binding PaevaPelkiri[1]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="2" 
                Text="{Binding PaevaPelkiri[2]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="3" 
                Text="{Binding PaevaPelkiri[3]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="4" 
                Text="{Binding PaevaPelkiri[4]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="5" 
                Text="{Binding PaevaPelkiri[5]}" 
                Style="{StaticResource H2}"/>
            
            <Label 
                Grid.Column="6" 
                Text="{Binding PaevaPelkiri[6]}" 
                Style="{StaticResource H2}"/>
            
        </Grid>

        <!-- Сетка 7×6 -->
        <CollectionView 
            Grid.Row="3"
            ItemsSource="{Binding Paevad}"
            SelectionMode="None"
            ItemSizingStrategy="MeasureFirstItem">
            
            <CollectionView.ItemsLayout>
                
                <GridItemsLayout 
                    Orientation="Vertical" 
                    Span="7"/>
                
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                
                <DataTemplate>
                    
                    <Border 
                        Style="{StaticResource DayCard}">

                        <Border.Triggers>
                            
                            <DataTrigger 
                                TargetType="Border"
                                Binding="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}},
                                               Path=BindingContext.ValitudPaev,
                                               Converter={StaticResource RefEq},
                                               ConverterParameter={Binding .}}"
                                Value="True">
                                
                                <Setter Property="Stroke" Value="#f04e9e"/>
                                
                                <Setter Property="StrokeThickness" Value="2"/>
                                
                                <Setter Property="Shadow">
                                
                                    <Setter.Value>
                                        
                                        <Shadow 
                                            Brush="#f04e9e" 
                                            Radius="14" 
                                            Opacity="0.7"/>
                                    
                                    </Setter.Value>
                                
                                </Setter>
                            
                            </DataTrigger>
                            
                        </Border.Triggers>

                        <Grid 
                            RowDefinitions="Auto,Auto,Auto" 
                            RowSpacing="4">

                            <!-- Номер дня -->
                            <Label 
                                Grid.Row="0"
                                Text="{Binding PaevaNumber}"
                                HorizontalOptions="End"
                                TextColor="{StaticResource TextPri}">
                                
                                <Label.Triggers>
                                    
                                    <DataTrigger 
                                        TargetType="Label" 
                                        Binding="{Binding OnTana}" 
                                        Value="True">
                                        
                                        <Setter Property="FontAttributes" Value="Bold"/>
                                    
                                    </DataTrigger>
                                    
                                    <DataTrigger 
                                        TargetType="Label" 
                                        Binding="{Binding OnTeineKuu}" 
                                        Value="True">
                                        
                                        <Setter Property="Opacity" Value="0.35"/>
                                    
                                    </DataTrigger>
                                
                                </Label.Triggers>
                            
                            </Label>

                            <!-- Работники (цветные метки) -->
                            <VerticalStackLayout 
                                Grid.Row="1" 
                                Spacing="2">
                                
                                <!-- Когда есть список работников -->
                                <VerticalStackLayout 
                                    BindableLayout.ItemsSource="{Binding Tootajad}">
                                    
                                    <BindableLayout.ItemTemplate>
                                        
                                        <DataTemplate>
                                            
                                            <HorizontalStackLayout 
                                                Spacing="6">
                                                
                                                <BoxView 
                                                    WidthRequest="10" 
                                                    HeightRequest="10"
                                                    CornerRadius="5"
                                                    Color="{Binding Varv}" />
                                                
                                                <Label 
                                                    Text="{Binding Nimi}" 
                                                    FontSize="12" 
                                                    TextColor="{StaticResource TextPri}"/>
                                                
                                                <Label 
                                                    Text="{Binding Kellad}" 
                                                    FontSize="12" 
                                                    TextColor="{StaticResource TextSec}"/>
                                                
                                            </HorizontalStackLayout>
                                            
                                        </DataTemplate>
                                        
                                    </BindableLayout.ItemTemplate>
                                    
                                </VerticalStackLayout>

                                <!-- Когда работников нет -->
                                <Label 
                                    Text="{Binding TootajadRida}"
                                    FontSize="12"
                                    TextColor="{StaticResource TextSec}">
                                    
                                    <Label.Triggers>
                                        
                                        <DataTrigger 
                                            TargetType="Label" 
                                            Binding="{Binding OnKinni}" 
                                            Value="True">
                                            
                                            <Setter Property="Text" Value="Закрыто"/>
                                            
                                            <Setter Property="FontAttributes" Value="Italic"/>
                                        
                                        </DataTrigger>
                                        
                                        <DataTrigger 
                                            TargetType="Label" 
                                            Binding="{Binding OnTeineKuu}" 
                                            Value="True">
                                            
                                            <Setter Property="Opacity" Value="0.35"/>
                                        
                                        </DataTrigger>
                                    
                                    </Label.Triggers>
                                    
                                </Label>
                                
                            </VerticalStackLayout>

                            <!-- Дыры -->
                            <Label 
                                Grid.Row="2"
                                Text="{Binding TuhikRida}"
                                Style="{StaticResource Body12}"
                                TextColor="{StaticResource Danger}">
                                
                                <Label.Triggers>
                                    
                                    <DataTrigger 
                                        TargetType="Label" 
                                        Binding="{Binding OnTuhik}" 
                                        Value="False">
                                        
                                        <Setter Property="IsVisible" Value="False"/>
                                    
                                    </DataTrigger>
                                    
                                    <DataTrigger 
                                        TargetType="Label" 
                                        Binding="{Binding OnTeineKuu}" 
                                        Value="True">
                                        
                                        <Setter Property="Opacity" Value="0.35"/>
                                    
                                    </DataTrigger>
                                
                                </Label.Triggers>
                                
                            </Label>

                            <!-- Тап по дню -->
                            <Grid.GestureRecognizers>
                                
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AvatudPaevCommand}"
                                    CommandParameter="{Binding .}" />
                                
                            </Grid.GestureRecognizers>
                            
                        </Grid>
                        
                    </Border>
                    
                </DataTemplate>
                
            </CollectionView.ItemTemplate>
            
        </CollectionView>
        
    </Grid>
    
</ContentPage>
